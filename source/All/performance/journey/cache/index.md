---
title: ç¬¬ä¸€ç«™ï¼šç¼“å­˜
date: 2021-05-25 15:13:20
tag: performance
toc: true
---

ğŸ”[é¦–é¡µ](/All/performance/journey "æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…é¦–é¡µ")
æ¬¢è¿æ¥åˆ°ã€Œå‰ç«¯æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…ã€çš„ç¬¬ä¸€ç«™ â€”â€” ç¼“å­˜ã€‚

å½“æµè§ˆå™¨æƒ³è¦è·å–è¿œç¨‹çš„æ•°æ®æ—¶ï¼Œæˆ‘ä»¬çš„æ€§èƒ½ä¹‹æ—…å°±å¼€å§‹äº†ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬å¹¶ä¸ä¼šç«‹å³åŠ¨èº«(å‘é€è¯·æ±‚). åœ¨è®¡ç®—æœºé¢†åŸŸï¼Œå¾ˆå¤šæ€§èƒ½é—®é¢˜éƒ½ä¼šé€šè¿‡å¢åŠ ç¼“å­˜æ¥è§£å†³ï¼Œå‰ç«¯ä¹Ÿä¸ä¾‹å¤–ã€‚å’Œè®¸å¤šåç«¯æœåŠ¡ä¸€æ ·ï¼Œå‰ç«¯ç¼“å­˜ä¹Ÿæ˜¯å¤šçº§çš„ã€‚

## 1ã€æœ¬åœ°æ•°æ®å­˜å‚¨
é€šè¿‡ç»“åˆæœ¬åœ°å­˜å‚¨ï¼Œå¯ä»¥åœ¨ä¸šåŠ¡ä»£ç ä¾§å®ç°ç¼“å­˜ã€‚
å¯¹äºä¸€äº›è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ä¸šåŠ¡ä»£ç ä¾§è¿›è¡Œç¼“å­˜å¤„ç†ã€‚ç¼“å­˜æ–¹å¼åŒ…æ‹¬`localStorage`ã€`sessionStorage`ã€`indexedDB`ã€‚æŠŠè¿™å—åŠ å…¥ç¼“å­˜çš„è®¨è®ºä¹Ÿè®¸ä¼šæœ‰äº‰è®®ï¼Œä½†åˆ©ç”¨å¥½å®ƒç¡®å®èƒ½åœ¨ç¨‹åºä¾§è¾¾åˆ°ä¸€äº›ç±»ä¼¼ç¼“å­˜çš„èƒ½åŠ›ã€‚

ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„é¡µé¢ä¸Šæœ‰ä¸€ä¸ªæ—¥æ›´æ–°çš„æ¦œå•ï¼Œæˆ‘ä»¬å¯ä»¥åšä¸€ä¸ªå½“æ—¥ç¼“å­˜ï¼š

```js
//å½“ç”¨æˆ·åŠ è½½ç«™ç‚¹ä¸­çš„æ¦œå•ç»„ä»¶æ—¶ï¼Œå¯ä»¥é€šè¿‡è¯¥æ–¹æ³•è·å–æ¦œå•æ•°æ®
async function readListData() {
    const info = JOSN.parse(localStorage.getItem('listInfo'));
    if (isExpired(info.time, +(new Date))) {
        const list = await fetchList();
        localStorage.setItem('listInfo', JSON.stringify({
            time: +(new Date),
            list: list
        }));
        return list;
    }
    return info.list;
}
```
localStorage å¤§å®¶éƒ½æ¯”è¾ƒäº†è§£äº†ï¼ŒindexedDB å¯èƒ½ä¼šäº†è§£çš„æ›´å°‘ä¸€äº›ã€‚

## 2ã€å†…å­˜ç¼“å­˜ï¼ˆMemoryï¼‰
å½“ä½ è®¿é—®ä¸€ä¸ªé¡µé¢åŠå…¶å­èµ„æºæ—¶ï¼Œæœ‰æ—¶å€™ä¼šå‡ºç°ä¸€ä¸ªèµ„æºè¢«ä½¿ç”¨å¤šæ¬¡ï¼Œä¾‹å¦‚å›¾æ ‡ã€‚ç”±äºè¯¥èµ„æºå·²ç»å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå†å»è¯·æ±‚åè€Œå¤šæ­¤ä¸€ä¸¾ï¼Œæµè§ˆå™¨å†…å­˜åˆ™æ˜¯æœ€è¿‘ã€æœ€å¿«çš„å“åº”åœºæ‰€ã€‚
å†…å­˜ç¼“å­˜å¹¶æ— æ˜ç¡®çš„æ ‡å‡†è§„å®šï¼Œå®ƒä¸ HTTP è¯­ä¹‰ä¸‹çš„ç¼“å­˜å…³è”æ€§ä¸å¤§ï¼Œç®—æ˜¯æµè§ˆå™¨å¸®æˆ‘ä»¬å®ç°çš„ä¼˜åŒ–ï¼Œå¾ˆå¤šæ—¶å€™å…¶å®æˆ‘ä»¬æ„è¯†ä¸åˆ°ã€‚

## 3ã€Cache API
å½“æˆ‘ä»¬æ²¡æœ‰å‘½ä¸­å†…å­˜ç¼“å­˜æ—¶ï¼Œæ˜¯å¦å°±å¼€å§‹å‘é€è¯·æ±‚äº†å‘¢ï¼Ÿå…¶å®ä¸ä¸€å®šã€‚
åœ¨è¿™æ—¶æˆ‘ä»¬è¿˜å¯èƒ½ä¼šç¢°åˆ° `Cache API` é‡Œçš„ç¼“å­˜ï¼Œæåˆ°å®ƒå°±ä¸å¾—ä¸æä¸€ä¸‹ `Service Worker` äº†ã€‚å®ƒä»¬é€šå¸¸éƒ½æ˜¯é…åˆä½¿ç”¨çš„ã€‚
é¦–å…ˆæ˜ç¡®ä¸€ä¸‹ï¼Œè¿™å±‚çš„ç¼“å­˜æ²¡æœ‰è§„å®šè¯´è¯¥ç¼“å­˜ä»€ä¹ˆã€ä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦ç¼“å­˜ï¼Œå®ƒåªæ˜¯æä¾›ç»™äº†å®¢æˆ·ç«¯æ„å»ºè¯·æ±‚ç¼“å­˜æœºåˆ¶çš„èƒ½åŠ›ã€‚å¦‚æœä½ å¯¹ PWA æˆ–è€… Service Worker å¾ˆäº†è§£ï¼Œåº”è¯¥éå¸¸æ¸…æ¥šæ˜¯æ€ä¹ˆä¸€å›äº‹ã€‚å¦‚æœä¸äº†è§£ä¹Ÿæ²¡æœ‰å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çœ‹ä¸€ä¸‹ï¼š

é¦–å…ˆï¼ŒService Worker æ˜¯ä¸€ä¸ªåå°è¿è¡Œçš„ç‹¬ç«‹çº¿ç¨‹ï¼Œå¯ä»¥åœ¨ä»£ç ä¸­å¯ç”¨
```js
//index.js
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js').then(function () {
        //æ³¨å†ŒæˆåŠŸ
    });
}
```
ä¹‹åéœ€è¦å¤„ç†ä¸€äº›Service Workerçš„ç”Ÿå‘½å‘¨æœŸäº‹ä»¶ï¼Œè€Œå…¶ä¸­ä¸è¿™é‡Œæåˆ°çš„ç¼“å­˜åŠŸèƒ½ç›´æ¥ç›¸å…³çš„åˆ™æ˜¯è¯·æ±‚æ‹¦æˆªï¼š
```js
//sw.js
self.addEventListener('fetch', function (e) {
    //å¦‚æœæœ‰cacheåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™é€šè¿‡fetchè¯·æ±‚
    e.respondWith(
        caches.match(e.request).then(function (cache) {
            return cache || fetch(e.quest);
        }).cache(function (err) {
            console.log(err);
            return fetch(e.request);
        });
    );
});
```
ä»¥ä¸Šä»£ç ä¼šæ‹¦æˆªæ‰€æœ‰çš„ç½‘ç»œè¯·æ±‚ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç¼“å­˜çš„è¯·æ±‚å†…å®¹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›ç¼“å­˜ï¼Œå¦åˆ™ä¼šç»§ç»­å‘é€è¯·æ±‚ã€‚ä¸å†…å­˜ç¼“å­˜ä¸åŒï¼ŒCache API æä¾›çš„ç¼“å­˜å¯ä»¥è®¤ä¸ºæ˜¯â€œæ°¸ä¹…æ€§â€çš„ï¼Œå…³é—­æµè§ˆå™¨æˆ–ç¦»å¼€é¡µé¢ä¹‹åï¼Œä¸‹æ¬¡å†è®¿é—®ä»ç„¶å¯ä»¥ä½¿ç”¨ã€‚

## 4ã€HTTPç¼“å­˜
å¦‚æœ Service Worker ä¸­ä¹Ÿæ²¡æœ‰ç¼“å­˜çš„è¯·æ±‚ä¿¡æ¯ï¼Œé‚£ä¹ˆå°±ä¼šçœŸæ­£åˆ° HTTP request çš„é˜¶æ®µäº†ã€‚è¿™ä¸ªæ—¶å€™å‡ºç°çš„å°±æ˜¯æˆ‘ä»¬æ‰€ç†ŸçŸ¥çš„ HTTP ç¼“å­˜è§„èŒƒã€‚
HTTP æœ‰ä¸€ç³»åˆ—çš„è§„èŒƒæ¥è§„å®šå“ªäº›æƒ…å†µä¸‹éœ€è¦ç¼“å­˜è¯·æ±‚ä¿¡æ¯ã€ç¼“å­˜å¤šä¹…ï¼Œè€Œå“ªäº›æƒ…å†µä¸‹ä¸èƒ½è¿›è¡Œä¿¡æ¯çš„ç¼“å­˜ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›¸å…³çš„ HTTP è¯·æ±‚å¤´æ¥å®ç°ç¼“å­˜ã€‚

**HTTP ç¼“å­˜å¤§è‡´å¯ä»¥åˆ†ä¸ºå¼ºç¼“å­˜ä¸åå•†ç¼“å­˜ã€‚**

### 4.1ã€å¼ºç¼“å­˜
åœ¨å¼ºç¼“å­˜çš„æƒ…å†µä¸‹ï¼Œæµè§ˆå™¨ä¸ä¼šå‘æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼Œè€Œæ˜¯ç›´æ¥ä»æœ¬åœ°ç¼“å­˜ä¸­è¯»å–å†…å®¹ï¼Œè¿™ä¸ª"æœ¬åœ°"ä¸€èˆ¬å°±æ˜¯æ¥æºä¸ç¡¬ç›˜ã€‚è¿™ä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨Chrome DevToolsä¸Šç»å¸¸çœ‹åˆ°çš„[disk cache].
ä¸å…¶ç›¸å…³çš„å“åº”å¤´åˆ™æ˜¯ `Expires` å’Œ `Cache-Control`ã€‚åœ¨ `Expires` ä¸Šå¯ä»¥è®¾ç½®ä¸€ä¸ªè¿‡æœŸæ—¶é—´ï¼Œæµè§ˆå™¨é€šè¿‡å°†å…¶ä¸å½“å‰æœ¬åœ°æ—¶é—´å¯¹æ¯”ï¼Œåˆ¤æ–­èµ„æºæ˜¯å¦è¿‡æœŸï¼Œæœªè¿‡æœŸåˆ™ç›´æ¥ä»æœ¬åœ°å–å³å¯ã€‚è€Œ `Cache-Control` åˆ™å¯ä»¥é€šè¿‡ç»™å®ƒè®¾ç½®ä¸€ä¸ª `max-age`ï¼Œæ¥æ§åˆ¶è¿‡æœŸæ—¶é—´ã€‚ä¾‹å¦‚ï¼Œ`max-age=300` å°±æ˜¯è¡¨ç¤ºåœ¨å“åº”æˆåŠŸå 300 ç§’å†…ï¼Œèµ„æºè¯·æ±‚ä¼šèµ°å¼ºç¼“å­˜.

### 4.2ã€åå•†ç¼“å­˜
ä½ å¯èƒ½ä¹Ÿæ„Ÿè§‰åˆ°äº†ï¼Œå¼ºç¼“å­˜ä¸æ˜¯é‚£ä¹ˆçµæ´»ã€‚å¦‚æœæˆ‘åœ¨ 300 ç§’å†…æ›´æ–°äº†èµ„æºï¼Œéœ€è¦æ€ä¹ˆé€šçŸ¥å®¢æˆ·ç«¯å‘¢ï¼Ÿå¸¸ç”¨çš„æ–¹å¼å°±æ˜¯é€šè¿‡åå•†ç¼“å­˜ã€‚
æˆ‘ä»¬çŸ¥é“ï¼Œè¿œç¨‹è¯·æ±‚æ…¢çš„ä¸€å¤§åŸå› å°±æ˜¯æŠ¥æ–‡ä½“ç§¯è¾ƒå¤§ã€‚åå•†ç¼“å­˜å°±æ˜¯å¸Œæœ›èƒ½é€šè¿‡å…ˆâ€œé—®ä¸€é—®â€æœåŠ¡å™¨èµ„æºåˆ°åº•æœ‰æ²¡æœ‰è¿‡æœŸï¼Œæ¥é¿å…æ— è°“çš„èµ„æºä¸‹è½½ã€‚è¿™ä¼´éšçš„å¾€å¾€ä¼šæ˜¯ HTTP è¯·æ±‚ä¸­çš„ 304 å“åº”ç ã€‚ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹å®ç°åå•†ç¼“å­˜çš„ä¸¤ç§æ–¹å¼ï¼š

>ä¸€ç§åå•†ç¼“å­˜çš„æ–¹å¼æ˜¯ï¼šæœåŠ¡å™¨ç¬¬ä¸€æ¬¡å“åº”æ—¶è¿”å› `Last-Modified`ï¼Œè€Œæµè§ˆå™¨åœ¨åç»­è¯·æ±‚æ—¶å¸¦ä¸Šå…¶å€¼ä½œä¸º `If-Modified-Since`ï¼Œç›¸å½“äºé—®æœåŠ¡ç«¯ï¼šXX æ—¶é—´ç‚¹ä¹‹åï¼Œè¿™ä¸ªèµ„æºæ›´æ–°äº†ä¹ˆï¼ŸæœåŠ¡å™¨æ ¹æ®å®é™…æƒ…å†µå›ç­”å³å¯ï¼šæ›´æ–°äº†ï¼ˆçŠ¶æ€ç  200ï¼‰æˆ–æ²¡æ›´æ–°ï¼ˆçŠ¶æ€ç  304ï¼‰ã€‚

>ä¸Šé¢æ˜¯é€šè¿‡æ—¶é—´æ¥åˆ¤æ–­æ˜¯å¦æ›´æ–°ï¼Œå¦‚æœæ›´æ–°æ—¶é—´é—´éš”è¿‡çŸ­ï¼Œä¾‹å¦‚ 1s ä¸€ä¸‹ï¼Œé‚£ä¹ˆä½¿ç”¨æ›´æ–°æ—¶é—´çš„æ–¹å¼ç²¾åº¦å°±ä¸å¤Ÿäº†ã€‚æ‰€ä»¥è¿˜æœ‰ä¸€ç§æ˜¯é€šè¿‡æ ‡è¯† â€”â€” `ETag`ã€‚æœåŠ¡å™¨ç¬¬ä¸€æ¬¡å“åº”æ—¶è¿”å› `ETag`ï¼Œè€Œæµè§ˆå™¨åœ¨åç»­è¯·æ±‚æ—¶å¸¦ä¸Šå…¶å€¼ä½œä¸º `If-None-Match`ã€‚ä¸€èˆ¬ä¼šç”¨æ–‡ä»¶çš„ MD5 ä½œä¸º ETagã€‚

>ä¸Šé¢è¿™äº›çš„å„çº§ç¼“å­˜çš„åŒ¹é…æœºåˆ¶é‡Œï¼Œéƒ½æ˜¯åŒ…å«èµ„æºçš„ uri çš„åŒ¹é…ï¼Œå³ uri æ›´æ”¹åä¸ä¼šå‘½ä¸­ç¼“å­˜ã€‚ä¹Ÿæ­£æ˜¯å¦‚æ­¤ï¼Œæˆ‘ä»¬ç›®å‰åœ¨å‰ç«¯å®è·µä¸­éƒ½ä¼šæŠŠæ–‡ä»¶ HASH åŠ å…¥åˆ°æ–‡ä»¶åä¸­ï¼Œé¿å…åŒåæ–‡ä»¶å‘½ä¸­ç¼“å­˜çš„æ—§èµ„æºã€‚

## 5ã€Push Cache
å‡å¦‚å¾ˆä¸å¹¸ï¼Œä»¥ä¸Šè¿™äº›ç¼“å­˜ä½ éƒ½æ²¡æœ‰å‘½ä¸­ï¼Œé‚£ä¹ˆä½ å°†ä¼šç¢°åˆ°æœ€åä¸€ä¸ªç¼“å­˜æ£€æŸ¥ â€”â€” Push Cacheã€‚
Push Cache å…¶å®æ˜¯ HTTP/2 çš„ Push åŠŸèƒ½æ‰€å¸¦æ¥çš„ã€‚ç®€è¨€ä¹‹ï¼Œè¿‡å»ä¸€ä¸ª HTTP çš„è¯·æ±‚è¿æ¥åªèƒ½ä¼ è¾“ä¸€ä¸ªèµ„æºï¼Œè€Œç°åœ¨ä½ åœ¨è¯·æ±‚ä¸€ä¸ªèµ„æºçš„åŒæ—¶ï¼ŒæœåŠ¡ç«¯å¯ä»¥ä¸ºä½ â€œæ¨é€â€ä¸€äº›å…¶ä»–èµ„æº â€”â€” ä½ å¯èƒ½åœ¨åœ¨ä¸ä¹…çš„å°†æ¥å°±ä¼šç”¨åˆ°ä¸€äº›èµ„æºã€‚ä¾‹å¦‚ï¼Œä½ åœ¨è¯·æ±‚ www.sample.com æ—¶ï¼ŒæœåŠ¡ç«¯ä¸ä»…å‘é€äº†é¡µé¢æ–‡æ¡£ï¼Œè¿˜ä¸€èµ·æ¨é€äº† å…³é”® CSS æ ·å¼è¡¨ã€‚è¿™ä¹Ÿå°±é¿å…äº†æµè§ˆå™¨æ”¶åˆ°å“åº”ã€è§£æåˆ°ç›¸åº”ä½ç½®æ—¶æ‰ä¼šè¯·æ±‚æ‰€å¸¦æ¥çš„å»¶åã€‚

ä¸è¿‡ HTTP/2 Push Cache æ˜¯ä¸€ä¸ªæ¯”è¾ƒåº•å±‚çš„ç½‘ç»œç‰¹æ€§ï¼Œä¸å…¶ä»–çš„ç¼“å­˜æœ‰å¾ˆå¤šä¸åŒï¼Œä¾‹å¦‚ï¼š
* å½“åŒ¹é…ä¸Šæ—¶ï¼Œå¹¶ä¸ä¼šåœ¨é¢å¤–æ£€æŸ¥èµ„æºæ˜¯å¦è¿‡æœŸï¼›
* å­˜æ´»æ—¶é—´å¾ˆçŸ­ï¼Œç”šè‡³çŸ­è¿‡å†…å­˜ç¼“å­˜ï¼ˆä¾‹å¦‚æœ‰æ–‡ç« æåˆ°ï¼ŒChrome ä¸­ä¸º 5min å·¦å³ï¼‰ï¼›
* åªä¼šè¢«ä½¿ç”¨ä¸€æ¬¡ï¼›
* HTTP/2 è¿æ¥æ–­å¼€å°†å¯¼è‡´ç¼“å­˜ç›´æ¥å¤±æ•ˆï¼›
â€¦â€¦

>[ä¸‹ä¸€ç«™ï¼šå‘é€è¯·æ±‚ğŸ”œ](/All/performance/journey/request "å‘é€è¯·æ±‚")


