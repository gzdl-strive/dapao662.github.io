---
title: useEffectæŒ‡å—(2)
date: 2020-10-26 10:18:53
tag: Hook
toc: true
comments: true
---

## ä¸è¦å› ä¸ºä¾èµ–è€Œæ’’è°

åœ¨ä¾èµ–å…³ç³»ä¸Šæ’’è°ä¼šå¸¦æ¥ä¸å¥½çš„åæœã€‚ä»ç›´è§‰ä¸Šçœ‹, è¿™æ˜¯æœ‰é“ç†çš„, ä½†æˆ‘çœ‹åˆ°å‡ ä¹æ¯ä¸ªäººéƒ½å°è¯•ä½¿ç”¨ `useEffect` ä¸ç±»ä¸­çš„å¿ƒç†æ¨¡å‹è¯•å›¾æ¬ºéª—è§„åˆ™ã€‚(ä¸€å¼€å§‹æˆ‘ä¹Ÿè¿™ä¹ˆåšäº†!)

``` js
function SearchResults() {
    async function fetchData() {
        // ...
    }

    useEffect(() => {
        fetchData();
    }, []); // Is this okay? Not always -- and there's a better way to write it.

    // ...
}
```

([Hook FAQ](https://reactjs.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies)è§£é‡Šäº†åº”è¯¥æ€ä¹ˆåšã€‚æˆ‘ä»¬å°†åœ¨ä¸‹é¢å›åˆ°è¿™ä¸ªä¾‹å­ã€‚)
"ä½†æˆ‘åªæƒ³åœ¨mountæ—¶è¿è¡Œå®ƒï¼"ï¼Œä½ ä¼šè¿™ä¹ˆè¯´ã€‚ç°åœ¨ï¼Œè¯·è®°ä½ï¼šå¦‚æœä½ æŒ‡å®š `deps` ï¼Œç»„ä»¶å†…éƒ¨çš„æ•ˆæœæ‰€ä½¿ç”¨çš„æ‰€æœ‰å€¼éƒ½å¿…é¡»åœ¨é‚£é‡Œã€‚åŒ…æ‹¬**propsï¼ŒçŠ¶æ€ï¼Œå‡½æ•° - ç»„ä»¶ä¸­çš„ä»»ä½•å†…å®¹**ã€‚
æœ‰æ—¶ï¼Œå½“ä½ è¿™æ ·åšæ—¶ï¼Œå®ƒä¼šå¯¼è‡´é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œä½ å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªæ— é™é‡å–å¾ªç¯ï¼Œæˆ–è€…ä¸€ä¸ªsocketè¢«é‡æ–°åˆ›å»ºå¾—å¤ªé¢‘ç¹ã€‚ **è¯¥é—®é¢˜çš„è§£å†³æ–¹æ¡ˆä¸æ˜¯åˆ é™¤ä¾èµ–é¡¹ã€‚** æˆ‘ä»¬å¾ˆå¿«å°±ä¼šçœ‹åˆ°è¿™äº›è§£å†³æ–¹æ¡ˆã€‚

ä½†åœ¨æˆ‘ä»¬è·³åˆ°è§£å†³æ–¹æ¡ˆä¹‹å‰ï¼Œè®©æˆ‘ä»¬æ›´å¥½åœ°ç†è§£é—®é¢˜ã€‚

## å½“ä¾èµ–å…³ç³»æ¬ºéª—æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ

å¦‚æœ `deps` (ä¾èµ–é¡¹)åŒ…å«äº†æ•ˆæœä½¿ç”¨çš„æ‰€æœ‰å€¼ï¼ŒReactçŸ¥é“ä»€ä¹ˆæ—¶å€™é‡æ–°è¿è¡Œå®ƒ:

``` js
useEffect(() => {
    document.title = 'Hello, ' + name;
}, [name]); // å…³æ³¨è¿™ä¸ªä¾èµ–é¡¹
```

![image1](/assets/useEffectImg/2-1.webp "image1")

**(ä¾èµ–å…³ç³»æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡æ–°è¿è¡Œæ•ˆæœã€‚)**

ä½†æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬ä¸ºæ­¤æ•ˆæœæŒ‡å®šäº†[]ï¼Œåˆ™æ–°æ•ˆæœå‡½æ•°å°†ä¸ä¼šè¿è¡Œï¼š

``` js
useEffect(() => {
    document.title = 'Hello, ' + name;
}, []); // Wrong: name is missing in deps
```

![image2](/assets/useEffectImg/2-2.webp "image2")

**(ä¾èµ–é¡¹æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è·³è¿‡è¿™ä¸ªæ•ˆæœã€‚)**

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé—®é¢˜å¯èƒ½æ˜¾è€Œæ˜“è§ã€‚ä½†æ˜¯ï¼Œåœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œå½“ç±»è§£å†³æ–¹æ¡ˆä»ä½ çš„è®°å¿†ä¸­â€œè·³å‡ºâ€æ—¶ï¼Œè¿™ç§ç›´è§‰å¯èƒ½ä¼šæ¬ºéª—ä½ ã€‚

ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªæ¯ç§’é€’å¢ä¸€æ¬¡çš„è®¡æ•°å™¨ã€‚å¯¹äºç±»ï¼Œæˆ‘ä»¬çš„ç›´è§‰æ˜¯ï¼šâ€œè®¾ç½®é—´éš”( `interval` )ä¸€æ¬¡ï¼Œé”€æ¯é—´éš”ä¸€æ¬¡â€ã€‚è¿™æ˜¯ä¸€ä¸ªæˆ‘ä»¬å¦‚ä½•åšçš„ä¾‹å­ã€‚å½“æˆ‘ä»¬åœ¨å¿ƒç†ä¸Šå°†æ­¤ä»£ç ç¿»è¯‘ä¸º `useEffect` æ—¶ï¼Œæˆ‘ä»¬æœ¬èƒ½åœ°å°†[]æ·»åŠ åˆ°depsä¸­ã€‚â€œæˆ‘æƒ³è®©å®ƒè·‘ä¸€æ¬¡â€ï¼Œå¯¹å—ï¼Ÿ

``` js
function Counter() {
    const [count, setCount] = useState(0);

    useEffect(() => {
        const id = setInterval(() => {
            setCount(count + 1);
        }, 1000);
        return () => clearInterval(id);
    }, []); //ä½ çš„å…³æ³¨ç‚¹åœ¨è¿™é‡Œ

    return <h1 > {
        count
    } < /h1>;
}
```

ä½†æ˜¯ï¼Œæ­¤ç¤ºä¾‹**ä»…é€’å¢ä¸€æ¬¡**ã€‚å“å‘€ã€‚

å¦‚æœä½ çš„å¿ƒç†æ¨¡å‹æ˜¯â€œä¾èµ–å…³ç³»è®©æˆ‘æŒ‡å®šä½•æ—¶æˆ‘æƒ³é‡æ–°è§¦å‘æ•ˆæœâ€ï¼Œè¿™ä¸ªä¾‹å­å¯èƒ½ä¼šç»™ä½ ä¸€ä¸ªå­˜åœ¨çš„å±æœºã€‚ä½ æƒ³è¦è§¦å‘å®ƒä¸€æ¬¡ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªé—´éš” - æ‰€ä»¥å®ƒä¸ºä»€ä¹ˆä¼šå¼•èµ·é—®é¢˜ï¼Ÿ

ä½†æ˜¯ï¼Œ**å¦‚æœä½ çŸ¥é“ä¾èµ–é¡¹æ˜¯æˆ‘ä»¬çš„æç¤ºï¼Œç”¨äºå¯¹æ•ˆæœåœ¨æ¸²æŸ“èŒƒå›´ä¸­ä½¿ç”¨çš„æ‰€æœ‰å†…å®¹ä½œå‡ºååº”ï¼Œé‚£ä¹ˆè¿™æ ·åšæ˜¯æœ‰æ„ä¹‰çš„ã€‚**å®ƒä½¿ç”¨ `count` ï¼Œä½†æˆ‘ä»¬ä½¿ç”¨[]æ’’è°è¯´å®ƒæ²¡æœ‰ä¾èµ–ã€‚å®ƒä¼šå‘åˆ°æˆ‘ä»¬ï¼Œè¿™åªæ˜¯æ—¶é—´é—®é¢˜!

åœ¨ç¬¬ä¸€æ¬¡æ¸²æŸ“ä¸­ï¼Œ `count` ä¸º0. å› æ­¤ï¼Œç¬¬ä¸€ä¸ªæ¸²æŸ“æ•ˆæœä¸­çš„ `setCount(count + 1)` è¡¨ç¤º `setCount(0 + 1)` ã€‚å› ä¸º `[] deps` æˆ‘ä»¬æ°¸è¿œä¸ä¼šé‡æ–°è¿è¡Œæ•ˆæœï¼Œæ‰€ä»¥å®ƒä¼šæ¯ç§’è°ƒç”¨ `setCount(0 + 1)` ï¼š

``` js
// First render, state is 0
function Counter() {
    // ...
    useEffect(
        // Effect from first render
        () => {
            const id = setInterval(() => {
                +setCount(0 + 1); // Always setCount(1)
            }, 1000);
            return () => clearInterval(id);
        },
        +[] // Never re-runs
    );
    // ...
}

// Every next render, state is 1
function Counter() {
    // ...
    useEffect(

        + // This effect is always ignored because
        + // we lied to React about empty deps.

        () => {
            const id = setInterval(() => {
                setCount(1 + 1);
            }, 1000);
            return () => clearInterval(id);
        },
        []
    );
    // ...
}
```

**æˆ‘ä»¬æ’’è°è¯´æˆ‘ä»¬çš„æ•ˆæœä¸ä¾èµ–äºç»„ä»¶å†…éƒ¨çš„å€¼ï¼Œè€Œå®é™…ä¸Šå®ƒä¾èµ–äºç»„ä»¶å†…éƒ¨çš„å€¼!**
æˆ‘ä»¬çš„æ•ˆæœä½¿ç”¨ `count` - ç»„ä»¶å†…éƒ¨çš„å€¼ï¼ˆä½†åœ¨effectæ•ˆæœä¹‹å¤–ï¼‰ï¼š

``` js
+
const count = // ...

    useEffect(() => {
        const id = setInterval(() => {
            +setCount(count + 1);
        }, 1000);
        return () => clearInterval(id);
    }, []);
```

å› æ­¤ï¼Œå°†[]æŒ‡å®šä¸ºä¾èµ–é¡¹å°†äº§ç”Ÿä¸€ä¸ªé”™è¯¯ã€‚Reactå°†æ¯”è¾ƒä¾èµ–é¡¹ï¼Œå¹¶è·³è¿‡æ›´æ–°æ­¤æ•ˆæœï¼š

![image3](/assets/useEffectImg/2-3.webp "image3")

**(ä¾èµ–æ€§æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è·³è¿‡è¿™ä¸ªæ•ˆæœã€‚)**
åƒè¿™æ ·çš„é—®é¢˜å¾ˆéš¾æƒ³åˆ°ã€‚å› æ­¤ï¼Œæˆ‘é¼“åŠ±ä½ å°†å…¶ä½œä¸ºä¸€é¡¹ç¡¬æ€§è§„åˆ™ï¼Œå§‹ç»ˆè¯šå®åœ°éµå¾ªæ•ˆæœä¾èµ–å…³ç³»ï¼Œå¹¶å°†å…¶å…¨éƒ¨(æ•ˆæœæ‰€ç”¨åˆ°çš„)æŒ‡å®šã€‚(å¦‚æœä½ æƒ³åœ¨å›¢é˜Ÿä¸­å¼ºåˆ¶æ‰§è¡Œæ­¤æ“ä½œï¼Œæˆ‘ä»¬ä¼šæä¾›ä¸€ä¸ª `[lintè§„åˆ™](lint rule)` ã€‚)

## è¯šå®å¯¹å¾…ä¾èµ–å…³ç³»çš„ä¸¤ç§æ–¹æ³•

æœ‰ä¸¤ç§ç­–ç•¥å¯ä»¥è¯šå®åœ°å¯¹å¾…ä¾èµ–å…³ç³»ã€‚é€šå¸¸åº”è¯¥ä»ç¬¬ä¸€ä¸ªå¼€å§‹ï¼Œç„¶åæ ¹æ®éœ€è¦åº”ç”¨ç¬¬äºŒä¸ªã€‚
*ç¬¬ä¸€ç§ç­–ç•¥*æ˜¯**ä¿®å¤ä¾èµ–å…³ç³»æ•°ç»„**ï¼Œä»¥åŒ…å«åœ¨æ•ˆæœä¸­ä½¿ç”¨çš„ç»„ä»¶å†…çš„æ‰€æœ‰å€¼ã€‚æˆ‘ä»¬å°† `count` ä½œä¸º `dep` (ä¾èµ–)åŒ…æ‹¬ï¼š

``` js
useEffect(() => {
    const id = setInterval(() => {
        setCount(count + 1);
    }, 1000);
    return () => clearInterval(id);
}, [count]);
```

è¿™ä½¿ä¾èµ–é¡¹æ•°ç»„æ­£ç¡®ã€‚å®ƒå¯èƒ½ä¸å¤ªç†æƒ³ï¼Œä½†è¿™æ˜¯æˆ‘ä»¬éœ€è¦è§£å†³çš„ç¬¬ä¸€ä¸ªé—®é¢˜ã€‚ç°åœ¨æ”¹å˜ `count` å°†é‡æ–°è¿è¡Œæ•ˆæœï¼Œæ¯ä¸€ä¸ªä¸‹ä¸€ä¸ªé—´éš”å¼•ç”¨ `count` ä»å…¶æ¸²æŸ“åœ¨ `setCount(count + 1)` :

``` js
// First render, state is 0
function Counter() {
    // ...
    useEffect(
        // Effect from first render
        () => {
            const id = setInterval(() => {
                +setCount(0 + 1); // setCount(count + 1)
            }, 1000);
            return () => clearInterval(id);
        },
        +[0] // [count]
    );
    // ...
}

// Second render, state is 1
function Counter() {
    // ...
    useEffect(
        // Effect from second render
        () => {
            const id = setInterval(() => {
                +setCount(1 + 1); // setCount(count + 1)
            }, 1000);
            return () => clearInterval(id);
        },
        +[1] // [count]
    );
    // ...
}
```

è¿™æ ·å¯ä»¥è§£å†³é—®é¢˜ï¼Œä½†åªè¦ `count` å‘ç”Ÿå˜åŒ–ï¼Œæˆ‘ä»¬çš„é—´éš”å°±ä¼šè¢«æ¸…é™¤å¹¶å†æ¬¡è®¾ç½®ã€‚è¿™å¯èƒ½æ˜¯ä¸å—æ¬¢è¿çš„ï¼š

![image4](/assets/useEffectImg/2-4.webp "image4")

**(ä¾èµ–å…³ç³»æ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬é‡æ–°è¿è¡Œæ•ˆæœã€‚)**

*ç¬¬äºŒç§ç­–ç•¥*æ˜¯**æ›´æ”¹æˆ‘ä»¬çš„effectä»£ç **ï¼Œè¿™æ ·å®ƒå°±ä¸éœ€è¦æ¯”æˆ‘ä»¬æƒ³è¦çš„å€¼é¢‘ç¹çš„æ›´æ”¹ã€‚ æˆ‘ä»¬ä¸æƒ³åœ¨ä¾èµ–å…³ç³»ä¸Šæ’’è°â€”â€”æˆ‘ä»¬åªæ˜¯æƒ³æ”¹å˜æˆ‘ä»¬çš„æ•ˆæœï¼Œä½¿ä¾èµ–å…³ç³»æ›´å°‘ã€‚

è®©æˆ‘ä»¬çœ‹ä¸€äº›åˆ é™¤ä¾èµ–é¡¹çš„å¸¸ç”¨æŠ€å·§ã€‚

### ä½¿æ•ˆæœè‡ªç»™è‡ªè¶³

æˆ‘ä»¬å¸Œæœ›æ‘†è„±æ•ˆæœä¸­çš„ `count` ä¾èµ–æ€§ã€‚

``` js
useEffect(() => {
    const id = setInterval(() => {
        setCount(count + 1);
    }, 1000);
    return () => clearInterval(id);
}, [count]);
```

è¦åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬éœ€è¦é—®è‡ªå·±ï¼šæˆ‘ä»¬ä½¿ç”¨ `count` ç”¨æ¥åšä»€ä¹ˆï¼Ÿ å¥½åƒæˆ‘ä»¬åªå°†å®ƒç”¨äº `setCount` è°ƒç”¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œ**æˆ‘ä»¬å®é™…ä¸Šåœ¨ä½œç”¨åŸŸé‡Œæ ¹æœ¬ä¸éœ€è¦ `count` ã€‚**å½“æˆ‘ä»¬æƒ³è¦æ ¹æ®ä»¥å‰çš„çŠ¶æ€æ›´æ–°çŠ¶æ€æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `setState` çš„å‡½æ•°æ›´æ–°å½¢å¼ï¼š

``` js
useEffect(() => {
    const id = setInterval(() => {
        // ä½ çš„å…³æ³¨ç‚¹åœ¨è¿™é‡Œ
        setCount(c => c + 1);
    }, 1000);
    return () => clearInterval(id);
}, []);
```

æˆ‘å–œæ¬¢å°†è¿™äº›æƒ…å†µè§†ä¸ºâ€œé”™è¯¯(å‡çš„)ä¾èµ–â€ã€‚æ˜¯çš„ï¼Œ `count` æ˜¯ä¸€ä¸ªå¿…è¦çš„ä¾èµ–é¡¹ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨æ•ˆæœä¸­ç¼–å†™äº† `setCount(count + 1)` ã€‚ä½†æ˜¯ï¼Œæˆ‘ä»¬çœŸæ­£çš„éœ€è¦ `count` åªæ˜¯å»å°†å…¶è½¬æ¢ä¸º `count + 1` å¹¶å°†å…¶â€œå‘å›â€ç»™Reactã€‚ä½†æ˜¯Reactå·²ç»çŸ¥é“äº†å½“å‰çš„ `count` ã€‚**æˆ‘ä»¬éœ€è¦å‘Šè¯‰Reactçš„æ˜¯å¢åŠ è¿™ä¸ªçŠ¶æ€â€”â€”ä¸ç®¡å®ƒç°åœ¨æ˜¯ä»€ä¹ˆçŠ¶æ€ã€‚**
è¿™æ­£æ˜¯ `setCount(c => c + 1)` çš„ä½œç”¨ã€‚ä½ å¯ä»¥å°†å…¶çœ‹ä½œæ˜¯å‘Reactâ€œå‘é€ä¸€æ¡æŒ‡ä»¤â€æ¥å¯¹çŠ¶æ€åº”è¯¥å¦‚ä½•å˜åŒ–åšå‡ºååº”ã€‚è¿™ç§â€œæ›´æ–°å½¢å¼â€åœ¨å…¶ä»–æƒ…å†µä¸‹ä¹Ÿæœ‰å¸®åŠ©ï¼Œä¾‹å¦‚*æ‰¹é‡å¤šæ¬¡æ›´æ–°æ—¶*ã€‚

è¯·æ³¨æ„ï¼Œæˆ‘ä»¬å®é™…ä¸Šå·²ç»å®Œæˆäº†åˆ é™¤ä¾èµ–é¡¹çš„å·¥ä½œã€‚æˆ‘ä»¬æ²¡æœ‰æ¬ºéª—ä»–ã€‚æˆ‘ä»¬çš„æ•ˆæœä¸å†ä»æ¸²æŸ“ä½œç”¨åŸŸè¯»å– `count` å€¼ï¼š

![image5](/assets/useEffectImg/2-5.webp "image5")

**(ä¾èµ–é¡¹æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è·³è¿‡è¿™ä¸ªæ•ˆæœã€‚)**
å³ä½¿æ­¤æ•ˆæœä»…è¿è¡Œä¸€æ¬¡ï¼Œå±äºç¬¬ä¸€ä¸ªæ¸²æŸ“çš„é—´éš”å›è°ƒå®Œå…¨èƒ½å¤Ÿåœ¨æ¯æ¬¡é—´éš”è§¦å‘æ—¶å‘é€ `c => c + 1` æ›´æ–°æŒ‡ä»¤ã€‚å®ƒä¸å†éœ€è¦çŸ¥é“å½“å‰çš„è®¡æ•°å™¨çŠ¶æ€ã€‚ Reactå·²ç»çŸ¥é“äº†ã€‚

### åŠŸèƒ½æ›´æ–°å’ŒGoogleæ–‡æ¡£

è¿˜è®°å¾—æˆ‘ä»¬å¦‚ä½•è°ˆè®ºåŒæ­¥æ˜¯æ•ˆæœçš„å¿ƒç†æ¨¡å‹å—ï¼ŸåŒæ­¥çš„ä¸€ä¸ªæœ‰è¶£æ–¹é¢æ˜¯ï¼Œä½ ç»å¸¸å¸Œæœ›ä¿æŒç³»ç»Ÿä¹‹é—´çš„â€œæ¶ˆæ¯â€ä¸å…¶çŠ¶æ€æ— å…³ã€‚ä¾‹å¦‚ï¼Œåœ¨Google Docsä¸­ç¼–è¾‘æ–‡æ¡£å®é™…ä¸Šå¹¶ä¸ä¼šå°†æ•´ä¸ªé¡µé¢å‘é€åˆ°æœåŠ¡å™¨ã€‚é‚£å°†æ˜¯éå¸¸ä½æ•ˆçš„ã€‚ç›¸åï¼Œå®ƒä¼šå‘é€ç”¨æˆ·å°è¯•æ‰§è¡Œæ“ä½œçš„è¡¨ç¤ºã€‚

è™½ç„¶æˆ‘ä»¬çš„ç”¨ä¾‹æ˜¯ä¸åŒçš„ï¼Œä½†æ˜¯ç±»ä¼¼çš„å“²å­¦é€‚ç”¨äºæ•ˆæœã€‚**å®ƒåªæœ‰åŠ©äºå°†æœ€å°‘çš„å¿…è¦ä¿¡æ¯ä»æ•ˆæœå†…éƒ¨å‘é€åˆ°ç»„ä»¶ã€‚** åƒ `setCount(c => c + 1)` è¿™æ ·çš„æ›´æ–°å½¢å¼ä¼ é€’çš„ä¿¡æ¯ä¸¥æ ¼å°‘äº `setCount(count + 1)` ï¼Œå› ä¸ºå®ƒæ²¡æœ‰è¢«å½“å‰è®¡æ•° `(count)` â€œæ±¡æŸ“â€ã€‚å®ƒåªè¡¨ç¤ºåŠ¨ä½œ(â€œé€’å¢â€)ã€‚åœ¨Reactä¸­æ€è€ƒæ¶‰åŠåˆ°æ‰¾åˆ°æœ€å°çš„çŠ¶æ€ã€‚è¿™æ˜¯ç›¸åŒçš„åŸåˆ™ï¼Œä½†å¯¹äºæ›´æ–°ã€‚
ç¼–ç æ„å›¾(è€Œä¸æ˜¯ç»“æœ)ç±»ä¼¼äºè°·æ­Œæ–‡æ¡£è§£å†³åä½œç¼–è¾‘çš„æ–¹å¼ã€‚è™½ç„¶è¿™æ˜¯å»¶ä¼¸çš„ç±»æ¯”ï¼Œä½†åŠŸèƒ½æ›´æ–°åœ¨Reactä¸­ä¹Ÿæ‰®æ¼”ç€ç±»ä¼¼çš„è§’è‰²ã€‚å®ƒä»¬ç¡®ä¿æ¥è‡ªå¤šä¸ªæºçš„æ›´æ–°(äº‹ä»¶å¤„ç†ç¨‹åºã€æ•ˆæœè®¢é˜…ç­‰)èƒ½å¤Ÿä»¥å¯é¢„æµ‹çš„æ–¹å¼æ­£ç¡®åœ°åº”ç”¨äºæ‰¹å¤„ç†ä¸­ã€‚
**ä½†æ˜¯ï¼Œå³ä½¿æ˜¯ `setCount(c => c + 1)` ä¹Ÿä¸æ˜¯é‚£ä¹ˆå¥½ã€‚** å®ƒçœ‹èµ·æ¥æœ‰ç‚¹å¥‡æ€ªï¼Œå®ƒèƒ½åšçš„éå¸¸æœ‰é™ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡ï¼Œå®ƒä»¬çš„å€¼ç›¸äº’ä¾èµ–ï¼Œæˆ–è€…å¦‚æœæˆ‘ä»¬éœ€è¦æ ¹æ®propæ¥è®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€ï¼Œè¿™å¯¹æˆ‘ä»¬æ²¡æœ‰å¸®åŠ©ã€‚å¹¸è¿çš„æ˜¯ï¼ŒsetCount(c => c + 1)æœ‰ä¸€ä¸ªæ›´å¼ºå¤§çš„å§å¦¹æ¨¡å¼ã€‚å®ƒçš„åç§°æ˜¯useReducerã€‚

### å°†æ›´æ–°ä¸æ“ä½œè§£è€¦

è®©æˆ‘ä»¬ä¿®æ”¹å‰é¢çš„ä¾‹å­ï¼Œè®©å®ƒæœ‰ä¸¤ä¸ªçŠ¶æ€å˜é‡ï¼š `count` å’Œ `step` ã€‚æˆ‘ä»¬çš„é—´éš”å°†ä½¿ `count` å¢åŠ  `step` è¾“å…¥çš„å€¼ï¼š

``` js
function Counter() {
    const [count, setCount] = useState(0);
    const [step, setStep] = useState(1);

    useEffect(() => {
        const id = setInterval(() => {
            setCount(c => c + step);
        }, 1000);
        return () => clearInterval(id);
    }, [step]);

    return ( <>
        <h1> { count } </h1> 
        <input value = { step }
        onChange = {
            e => setStep(Number(e.target.value))
        }/> 
        </>
    );
}
```

è¯·æ³¨æ„ï¼Œ**æˆ‘ä»¬æ²¡æœ‰æ¬ºéª—ã€‚** ç”±äºæˆ‘å¼€å§‹åœ¨æ•ˆæœä¸­ä½¿ç”¨ `step` ï¼Œæˆ‘å°†å®ƒæ·»åŠ åˆ°ä¾èµ–é¡¹ä¸­ã€‚è¿™å°±æ˜¯ä»£ç æ­£ç¡®è¿è¡Œçš„åŸå› ã€‚
æ­¤ç¤ºä¾‹ä¸­çš„å½“å‰è¡Œä¸ºæ˜¯æ›´æ”¹ `step` é‡æ–°å¯åŠ¨é—´éš” - å› ä¸ºå®ƒæ˜¯å…¶ä¸­ä¸€ä¸ªä¾èµ–é¡¹ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿™æ­£æ˜¯ä½ æƒ³è¦çš„ï¼æ‹†é™¤ä¸€ä¸ªæ•ˆæœå¹¶é‡æ–°è®¾ç½®å®ƒæ²¡æœ‰é”™ï¼Œé™¤éæˆ‘ä»¬æœ‰å¾ˆå¥½çš„ç†ç”±ï¼Œå¦åˆ™æˆ‘ä»¬ä¸åº”è¯¥é¿å…è¿™æ ·åšã€‚

ä½†æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬å¸Œæœ›é—´éš”æ—¶é’Ÿä¸ä¼šåœ¨ `step` æ›´æ”¹æ—¶é‡ç½®ã€‚**æˆ‘ä»¬å¦‚ä½•ä»æ•ˆæœä¸­åˆ é™¤stepä¾èµ–ï¼Ÿ**
**è®¾ç½®çŠ¶æ€å˜é‡æ—¶ï¼Œå–å†³äºå¦ä¸€ä¸ªçŠ¶æ€å˜é‡çš„å½“å‰å€¼ï¼Œä½ å¯èƒ½å¸Œæœ›å°è¯•ä½¿ç”¨useReduceræ›¿æ¢å®ƒä»¬ã€‚**
å½“ä½ å‘ç°è‡ªå·±æ­£åœ¨ç¼–å†™ `setSomething(something =>â€¦)` æ—¶ï¼Œæ˜¯æ—¶å€™è€ƒè™‘ä½¿ç”¨ `reducer` äº†ã€‚ `reducer` å…è®¸ä½  **å°†è¡¨ç¤ºç»„ä»¶ä¸­å‘ç”Ÿçš„â€œæ“ä½œâ€ä¸çŠ¶æ€æ›´æ–°çš„å“åº”æ–¹å¼è§£è€¦ã€‚**
åœ¨æˆ‘ä»¬çš„æ•ˆæœä¸­ï¼Œè®©æˆ‘ä»¬å°† `step` ä¾èµ–å…³ç³»æ›¿æ¢ä¸º `dispatch` ä¾èµ–å…³ç³»:

``` js
const [state, dispatch] = useReducer(reducer, initialState);
const {
    count,
    step
} = state;

useEffect(() => {
    const id = setInterval(() => {
        dispatch({
            type: 'tick'
        }); // Instead of setCount(c => c + step);
    }, 1000);
    return () => clearInterval(id);
}, [dispatch]);
```

ä½ å¯èƒ½ä¼šé—®æˆ‘ï¼šâ€œè¿™æ€ä¹ˆä¼šæ›´å¥½ï¼Ÿâ€ç­”æ¡ˆæ˜¯**Reactä¿è¯dispatchå‡½æ•°åœ¨æ•´ä¸ªç»„ä»¶ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒä¸å˜ã€‚æ‰€ä»¥ä¸Šé¢çš„ä¾‹å­ä¸éœ€è¦é‡æ–°è®¢é˜…é—´éš”**
æˆ‘ä»¬è§£å†³äº†é—®é¢˜ï¼
*(ä½ å¯ä»¥çœç•¥depsä¸­çš„dispatchï¼ŒsetStateå’ŒuseRefå®¹å™¨å€¼ï¼Œå› ä¸ºReactä¿è¯å®ƒä»¬æ˜¯é™æ€çš„ã€‚ä½†æŒ‡å®šå®ƒä»¬ä¹Ÿæ²¡æœ‰åå¤„ã€‚)*
å®ƒä¸æ˜¯åœ¨æ•ˆæœä¸­è¯»å–çŠ¶æ€ï¼Œè€Œæ˜¯å‘é€ä¸€ä¸ªåŠ¨ä½œæ¥ç¼–ç *å‘ç”Ÿäº†ä»€ä¹ˆ*çš„ä¿¡æ¯ã€‚è¿™å…è®¸æˆ‘ä»¬çš„æ•ˆæœä¿æŒä¸ `step` çŠ¶æ€è§£è€¦ã€‚æˆ‘ä»¬çš„æ•ˆæœå¹¶ä¸å…³å¿ƒæˆ‘ä»¬å¦‚ä½•æ›´æ–°çŠ¶æ€ï¼Œå®ƒåªæ˜¯å‘Šè¯‰æˆ‘ä»¬å‘ç”Ÿäº†ä»€ä¹ˆã€‚

reduceré›†ä¸­äº†æ›´æ–°é€»è¾‘ï¼š

``` js
const initialState = {
    count: 0,
    step: 1,
};

function reducer(state, action) {
    const {
        count,
        step
    } = state;
    if (action.type === 'tick') {
        return {
            count: count + step,
            step
        };
    } else if (action.type === 'step') {
        return {
            count,
            step: action.step
        };
    } else {
        throw new Error();
    }
}
```

**(å¦‚æœä½ ä¹‹å‰é”™è¿‡äº†ï¼Œé‚£ä¹ˆè¿™æ˜¯ä¸€ä¸ªæ¼”ç¤º)**

### ä¸ºä»€ä¹ˆuseReduceræ˜¯Hooksçš„æ¬ºéª—æ¨¡å¼

æˆ‘ä»¬å·²ç»çœ‹åˆ°å½“æ•ˆæœéœ€è¦æ ¹æ®ä»¥å‰çš„çŠ¶æ€æˆ–å¦ä¸€ä¸ªçŠ¶æ€å˜é‡è®¾ç½®çŠ¶æ€æ—¶å¦‚ä½•åˆ é™¤ä¾èµ–å…³ç³»ã€‚ä½†æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦ `props` æ¥è®¡ç®—ä¸‹ä¸€ä¸ªçŠ¶æ€å‘¢ï¼Ÿ ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„ `API` å¯èƒ½æ˜¯ `<Counter step = {1} />` ã€‚å½“ç„¶ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸èƒ½é¿å…å°† `props.step` æŒ‡å®šä¸ºä¾èµ–é¡¹ï¼Ÿ
äº‹å®ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ï¼æˆ‘ä»¬å¯ä»¥å°† `reducer` æœ¬èº« æ”¾åœ¨æˆ‘ä»¬çš„ç»„ä»¶ä¸­æ¥è¯»å– `props` ï¼š

``` js
function Counter({
    step
}) {
    const [count, dispatch] = useReducer(reducer, 0);

    function reducer(state, action) {
        if (action.type === 'tick') {
            // ä½ çš„å…³æ³¨ç‚¹åº”è¯¥åœ¨è¿™é‡Œ
            return state + step;
        } else {
            throw new Error();
        }
    }

    useEffect(() => {
        const id = setInterval(() => {
            dispatch({
                type: 'tick'
            });
        }, 1000);
        return () => clearInterval(id);
    }, [dispatch]);

    return <h1 > {
        count
    } < /h1>;
}
```

è¿™ä¸ªæ¨¡å¼ç¦ç”¨äº†ä¸€äº›ä¼˜åŒ–ï¼Œæ‰€ä»¥å°½é‡ä¸è¦åœ¨ä»»ä½•åœ°æ–¹éƒ½ä½¿ç”¨å®ƒï¼Œä½†æ˜¯å¦‚æœéœ€è¦ï¼Œä½ å¯ä»¥å®Œå…¨ä»reducerè®¿é—®propsã€‚
**å³ä½¿åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œé‡æ–°æ¸²æŸ“ä¹‹é—´ä»ç„¶ä¿è¯dispatchæ ‡è¯†æ˜¯ç¨³å®šçš„ã€‚** å› æ­¤ï¼Œå¦‚æœéœ€è¦ï¼Œä½ å¯ä»¥ä»æ•ˆæœdepsä¸­çœç•¥å®ƒã€‚å®ƒä¸ä¼šå¯¼è‡´é‡æ–°è¿è¡Œæ•ˆæœã€‚
ä½ å¯èƒ½æƒ³çŸ¥é“ï¼šè¿™æ€ä¹ˆå¯èƒ½æœ‰æ•ˆå‘¢ï¼Ÿå½“ä»å±äºå¦ä¸€ä¸ªæ¸²æŸ“æ•ˆæœçš„å†…éƒ¨è°ƒç”¨æ—¶ï¼Œ `reducer` å¦‚ä½•â€œçŸ¥é“â€ `props` ? ç­”æ¡ˆæ˜¯ï¼Œå½“ä½  `dispatch` æ—¶ï¼ŒReactä¼šè®°ä½è¯¥æ“ä½œ - ä½†å®ƒä¼šåœ¨ä¸‹ä¸€æ¬¡æ¸²æŸ“æœŸé—´è°ƒç”¨ä½ çš„ `reducer` ã€‚åœ¨é‚£æ—¶ï¼Œæ–°çš„propså°†åœ¨ä½œç”¨åŸŸå†…ï¼Œä½ ä¸ä¼šåœ¨ä¸€ä¸ªæ•ˆæœå†…ã€‚
**è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘å–œæ¬¢å°†useReducerè§†ä¸ºHooksçš„â€œä½œå¼Š(æ¬ºéª—)æ¨¡å¼â€ã€‚å®ƒè®©æˆ‘å°†æ›´æ–°é€»è¾‘ä»æè¿°æ‰€å‘ç”Ÿçš„äº‹æƒ…ä¸­è§£è€¦å‡ºæ¥ã€‚åè¿‡æ¥ï¼Œè¿™æœ‰åŠ©äºæˆ‘ä»æˆ‘çš„æ•ˆæœä¸­åˆ é™¤ä¸å¿…è¦çš„ä¾èµ–é¡¹ï¼Œå¹¶é¿å…æ›´é¢‘ç¹åœ°é‡æ–°è¿è¡Œå®ƒä»¬ã€‚**

### ç§»åŠ¨å‡½æ•°åˆ°æ•ˆæœå†…

ä¸€ä¸ªå¸¸è§çš„é”™è¯¯æ˜¯è®¤ä¸ºå‡½æ•°ä¸åº”è¯¥æ˜¯ä¾èµ–å…³ç³»ã€‚ä¾‹å¦‚ï¼Œè¿™ä¼¼ä¹å¯ä»¥å·¥ä½œï¼š

``` js
function SearchResults() {
    const [data, setData] = useState({
        hits: []
    });

    async function fetchData() {
        const result = await axios(
            'https://hn.algolia.com/api/v1/search?query=react',
        );
        setData(result.data);
    }

    useEffect(() => {
        fetchData();
    }, []); // Is this okay?
    // ...
```

éœ€è¦æ˜ç¡®çš„æ˜¯ï¼Œæ­¤ä»£ç ç¡®å®æœ‰æ•ˆã€‚**ä½†æ˜¯ç®€å•åœ°å¿½ç•¥å±€éƒ¨å‡½æ•°çš„é—®é¢˜æ˜¯ï¼Œå½“ç»„ä»¶å¢é•¿æ—¶ï¼Œå¾ˆéš¾åˆ¤æ–­æˆ‘ä»¬æ˜¯å¦åœ¨å¤„ç†æ‰€æœ‰çš„æƒ…å†µ!**
æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬çš„ä»£ç æ˜¯è¿™æ ·æ‹†åˆ†çš„ï¼Œæ¯ä¸ªå‡½æ•°éƒ½è¦å¤§(å¾ˆé•¿ï¼Œä¸æ˜“ç»´æŠ¤)äº”å€ï¼š

``` js
function SearchResults() {
    // Imagine this function is long
    function getFetchUrl() {
        return 'https://hn.algolia.com/api/v1/search?query=react';
    }

    // Imagine this function is also long
    async function fetchData() {
        const result = await axios(getFetchUrl());
        setData(result.data);
    }

    useEffect(() => {
        fetchData();
    }, []);

    // ...
}
```

ç°åœ¨è®©æˆ‘ä»¬è¯´æˆ‘ä»¬ç¨ååœ¨å…¶ä¸­ä¸€ä¸ªå‡½æ•°ä¸­ä½¿ç”¨ä¸€äº›çŠ¶æ€æˆ–propï¼š

``` js
function SearchResults() {
    const [query, setQuery] = useState('react');

    // Imagine this function is also long
    function getFetchUrl() {
        +
        return 'https://hn.algolia.com/api/v1/search?query=' + query;
    }

    // Imagine this function is also long
    async function fetchData() {
        const result = await axios(getFetchUrl());
        setData(result.data);
    }

    useEffect(() => {
        fetchData();
    }, []);

    // ...
}
```

å¦‚æœæˆ‘ä»¬å¿˜è®°æ›´æ–°è°ƒç”¨è¿™äº›å‡½æ•°çš„ä»»ä½•æ•ˆæœçš„deps(å¯èƒ½é€šè¿‡å…¶ä»–å‡½æ•°ï¼)ï¼Œæˆ‘ä»¬çš„æ•ˆæœå°†æ— æ³•åŒæ­¥æ¥è‡ª `props` å’Œ `state` çš„æ›´æ”¹ã€‚è¿™å¬èµ·æ¥ä¸å¤ªå¥½ã€‚
å¹¸è¿çš„æ˜¯ï¼Œè¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚**å¦‚æœä½ åªåœ¨æ•ˆæœä¸­ä½¿ç”¨æŸäº›å‡½æ•°ï¼Œè¯·å°†å®ƒä»¬ç›´æ¥ç§»åŠ¨åˆ°è¯¥æ•ˆæœä¸­ï¼š**

``` js
function SearchResults() {
    // ...
    useEffect(() => {
        // ä½ çš„å…³æ³¨ç‚¹åœ¨è¿™é‡Œ
        // We moved these functions inside!
        function getFetchUrl() {
            return 'https://hn.algolia.com/api/v1/search?query=react';
        }
        async function fetchData() {
            const result = await axios(getFetchUrl());
            setData(result.data);
        }

        fetchData();
    }, []); // âœ… Deps are OK
    // ...
}
```

é‚£ä¹ˆæœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿæˆ‘ä»¬ä¸å†éœ€è¦è€ƒè™‘â€œä¼ é€’ä¾èµ–â€ã€‚æˆ‘ä»¬çš„ä¾èµ–æ•°ç»„ä¸å†æ¬ºéª—ä½ : **æˆ‘ä»¬çœŸçš„æ²¡æœ‰åœ¨æˆ‘ä»¬çš„æ•ˆæœä¸­ä½¿ç”¨æ¥è‡ªç»„ä»¶å¤–éƒ¨ä½œç”¨åŸŸçš„ä»»ä½•ä¸œè¥¿ã€‚**
å¦‚æœæˆ‘ä»¬ç¨åä¿®æ”¹ `getFetchUrl` ä»¥ä½¿ç”¨queryçŠ¶æ€ï¼Œæˆ‘ä»¬æ›´æœ‰å¯èƒ½æ³¨æ„åˆ°æˆ‘ä»¬åœ¨æ•ˆæœä¸­ç¼–è¾‘å®ƒ - å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‘æ•ˆæœä¾èµ–é¡¹æ·»åŠ queryï¼š

``` js
function SearchResults() {
    const [query, setQuery] = useState('react');

    useEffect(() => {
        function getFetchUrl() {
            return 'https://hn.algolia.com/api/v1/search?query=' + query;
        }

        async function fetchData() {
            const result = await axios(getFetchUrl());
            setData(result.data);
        }

        fetchData();
    }, [query]); // âœ… Deps are OK

    // ...
}
```

é€šè¿‡æ·»åŠ æ­¤ä¾èµ–é¡¹ï¼Œæˆ‘ä»¬ä¸ä»…ä»…æ˜¯â€œå®‰æŠšReactâ€ã€‚å½“ `query` å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œé‡æ–°è·å–æ•°æ®æ˜¯æœ‰æ„ä¹‰çš„ã€‚
`useEffect` **çš„è®¾è®¡è¿«ä½¿ä½ æ³¨æ„åˆ°æˆ‘ä»¬çš„æ•°æ®æµä¸­çš„å˜åŒ–ï¼Œå¹¶é€‰æ‹©æˆ‘ä»¬çš„æ•ˆæœåº”è¯¥å¦‚ä½•åŒæ­¥å®ƒâ€”â€”è€Œä¸æ˜¯å¿½ç•¥å®ƒï¼Œç›´åˆ°æˆ‘ä»¬çš„äº§å“ç”¨æˆ·é‡åˆ°bug**
æ„Ÿè°¢ `eslint-plugin-react-hooks` æ’ä»¶ä¸­çš„ `exhaustive-deps` lintè§„åˆ™ï¼Œä½ å¯ä»¥åœ¨ç¼–è¾‘å™¨ä¸­è¾“å…¥æ—¶åˆ†ææ•ˆæœï¼Œå¹¶è·å¾—æœ‰å…³ç¼ºå°‘å“ªäº›ä¾èµ–é¡¹çš„å»ºè®®ã€‚æ¢å¥è¯è¯´ï¼Œè®¡ç®—æœºå¯ä»¥å‘Šè¯‰ä½ ç»„ä»¶æœªæ­£ç¡®å¤„ç†å“ªäº›æ•°æ®æµæ›´æ”¹ã€‚

![image6](/assets/useEffectImg/2-6.webp "image6")

### ä½†æˆ‘ä¸èƒ½æŠŠè¿™ä¸ªå‡½æ•°æ”¾åœ¨ä¸€ä¸ªæ•ˆæœä¸­

æœ‰æ—¶ä½ å¯èƒ½ä¸æƒ³æŠŠå‡½æ•°ç§»åˆ°æ•ˆæœä¸­ã€‚ä¾‹å¦‚ï¼ŒåŒä¸€ç»„ä»¶ä¸­çš„å¤šä¸ªæ•ˆæœå¯èƒ½ä¼šè°ƒç”¨ç›¸åŒçš„å‡½æ•°ï¼Œå¹¶ä¸”ä½ ä¸å¸Œæœ›å¤åˆ¶å’Œç²˜è´´å…¶é€»è¾‘ã€‚æˆ–è®¸è¿™æ˜¯ä¸€ä¸ªpropã€‚
ä½ åº”è¯¥åœ¨æ•ˆæœä¾èµ–ä¸­è·³è¿‡è¿™æ ·çš„å‡½æ•°å—ï¼Ÿæˆ‘æƒ³ä¸æ˜¯ã€‚åŒæ ·ï¼Œ**æ•ˆæœä¸åº”è¯¥åœ¨ä¾èµ–å…³ç³»ä¸Šæ’’è°ã€‚** é€šå¸¸æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚ä¸€ä¸ªå¸¸è§çš„è¯¯è§£æ˜¯â€œä¸€ä¸ªå‡½æ•°æ°¸è¿œä¸ä¼šæ”¹å˜â€ã€‚ä½†æ­£å¦‚æˆ‘ä»¬åœ¨æ•´ç¯‡æ–‡ç« ä¸­æ‰€å­¦åˆ°çš„ï¼Œè¿™ä¸å¯èƒ½æ˜¯äº‹å®ã€‚å®é™…ä¸Šï¼Œç»„ä»¶å†…å®šä¹‰çš„å‡½æ•°ä¼šåœ¨æ¯ä¸ªæ¸²æŸ“ä¸­å‘ç”Ÿå˜åŒ–ï¼
**è¿™æœ¬èº«å°±æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚** å‡è®¾ä¸¤ä¸ªæ•ˆæœè°ƒç”¨ `getFetchUrl` ï¼š

``` js
function SearchResults() {
    function getFetchUrl(query) {
        return 'https://hn.algolia.com/api/v1/search?query=' + query;
    }

    useEffect(() => {
        const url = getFetchUrl('react');
        // ... Fetch data and do something ...
    }, []); // ğŸ”´ Missing dep: getFetchUrl

    useEffect(() => {
        const url = getFetchUrl('redux');
        // ... Fetch data and do something ...
    }, []); // ğŸ”´ Missing dep: getFetchUrl

    // ...
}
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½ä¸å¸Œæœ›åœ¨ä»»ä½•ä¸€ä¸ªæ•ˆæœä¸­ç§»åŠ¨ `getFetchUrl` ï¼Œå› ä¸ºè¿™æ ·ä½ å°±æ— æ³•å…±äº«é€»è¾‘ã€‚
å¦ä¸€æ–¹é¢ï¼Œå¦‚æœä½ å¯¹æ•ˆæœä¾èµ–æ€§â€œè¯šå®â€ï¼Œåˆ™å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ã€‚ç”±äºæˆ‘ä»¬çš„æ•ˆæœéƒ½ä¾èµ–äº `getFetchUrl` ï¼ˆæ¯ä¸ªæ¸²æŸ“éƒ½ä¸åŒ ï¼‰ï¼Œæˆ‘ä»¬çš„ä¾èµ–æ•°ç»„æ˜¯æ— ç”¨çš„ï¼š

``` js
function SearchResults() {
    // ğŸ”´ Re-triggers all effects on every render
    // ä½ çš„å…³æ³¨ç‚¹åœ¨è¿™é‡Œ
    function getFetchUrl(query) {
        return 'https://hn.algolia.com/api/v1/search?query=' + query;
    }

    useEffect(() => {
        const url = getFetchUrl('react');
        // ... Fetch data and do something ...
    }, [getFetchUrl]); // ğŸš§ Deps are correct but they change too often

    useEffect(() => {
        const url = getFetchUrl('redux');
        // ... Fetch data and do something ...
    }, [getFetchUrl]); // ğŸš§ Deps are correct but they change too often

    // ...
}
```

ä¸€ä¸ªè¯±äººçš„è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥è·³è¿‡ `deps` åˆ—è¡¨ä¸­çš„ `getFetchUrl` å‡½æ•°ã€‚ä½†æ˜¯ï¼Œæˆ‘ä¸è®¤ä¸ºè¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚è¿™ä½¿æˆ‘ä»¬å¾ˆéš¾æ³¨æ„åˆ°ä½•æ—¶å‘æ•°æ®æµæ·»åŠ éœ€è¦ç”±æ•ˆæœå¤„ç†çš„æ›´æ”¹ã€‚è¿™ä¼šå¯¼è‡´æˆ‘ä»¬ä¹‹å‰çœ‹åˆ°çš„â€œæ°¸ä¸æ›´æ–°é—´éš” `(interval)` â€ç­‰é”™è¯¯ã€‚

ç›¸åï¼Œè¿˜æœ‰å¦å¤–ä¸¤ç§æ›´ç®€å•çš„è§£å†³æ–¹æ¡ˆã€‚
**é¦–å…ˆï¼Œå¦‚æœå‡½æ•°ä¸ä½¿ç”¨ç»„ä»¶èŒƒå›´ä¸­çš„ä»»ä½•å†…å®¹ï¼Œä½ å¯ä»¥å°†å…¶æå‡åˆ°ç»„ä»¶å¤–éƒ¨ï¼Œç„¶ååœ¨æ•ˆæœä¸­è‡ªç”±ä½¿ç”¨å®ƒï¼š**

``` js
// âœ… Not affected by the data flow
function getFetchUrl(query) {
    return 'https://hn.algolia.com/api/v1/search?query=' + query;
}

function SearchResults() {
    useEffect(() => {
        const url = getFetchUrl('react');
        // ... Fetch data and do something ...
    }, []); // âœ… Deps are OK

    useEffect(() => {
        const url = getFetchUrl('redux');
        // ... Fetch data and do something ...
    }, []); // âœ… Deps are OK

    // ...
} // âœ… Not affected by the data flow
function getFetchUrl(query) {
    return 'https://hn.algolia.com/api/v1/search?query=' + query;
}

function SearchResults() {
    useEffect(() => {
        const url = getFetchUrl('react');
        // ... Fetch data and do something ...
    }, []); // âœ… Deps are OK

    useEffect(() => {
        const url = getFetchUrl('redux');
        // ... Fetch data and do something ...
    }, []); // âœ… Deps are OK

    // ...
}
```

**æ— éœ€åœ¨ `deps` ä¸­æŒ‡å®šå®ƒï¼Œå› ä¸ºå®ƒä¸åœ¨æ¸²æŸ“èŒƒå›´å†…ï¼Œå¹¶ä¸”ä¸å—æ•°æ®æµçš„å½±å“ã€‚å®ƒä¸èƒ½å¶ç„¶åœ°ä¾èµ–äº `props` æˆ–çŠ¶æ€ã€‚**

**æˆ–è€…ï¼Œä½ å¯ä»¥å°†å…¶åŒ…è£…åˆ°useCallback Hookä¸­ï¼š**

``` js
function SearchResults() {
    // âœ… Preserves identity when its own deps are the same
    // ä½ çš„å…³æ³¨ç‚¹åœ¨è¿™é‡Œ
    const getFetchUrl = useCallback((query) => {
        return 'https://hn.algolia.com/api/v1/search?query=' + query;
    }, []); // âœ… Callback deps are OK

    useEffect(() => {
        const url = getFetchUrl('react');
        // ... Fetch data and do something ...
    }, [getFetchUrl]); // âœ… Effect deps are OK

    useEffect(() => {
        const url = getFetchUrl('redux');
        // ... Fetch data and do something ...
    }, [getFetchUrl]); // âœ… Effect deps are OK

    // ...
}
```

`useCallback` å®é™…ä¸Šå°±åƒæ·»åŠ å¦ä¸€å±‚ä¾èµ–æ€§æ£€æŸ¥ã€‚å®ƒæ­£åœ¨å¦ä¸€ç«¯è§£å†³é—®é¢˜ â€” **æˆ‘ä»¬åªåœ¨å¿…è¦æ—¶æ›´æ”¹å‡½æ•°æœ¬èº«ï¼Œè€Œä¸æ˜¯é¿å…å‡½æ•°ä¾èµ–ã€‚**
è®©æˆ‘ä»¬çœ‹çœ‹ä¸ºä»€ä¹ˆè¿™ç§æ–¹æ³•å¾ˆæœ‰ç”¨ã€‚ä»¥å‰ï¼Œæˆ‘ä»¬çš„ç¤ºä¾‹æ˜¾ç¤ºäº†ä¸¤ä¸ªæœç´¢ç»“æœï¼ˆé’ˆå¯¹ `'react'` å’Œ `'redux'` æœç´¢æŸ¥è¯¢ï¼‰ã€‚ä½†æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬è¦æ·»åŠ ä¸€ä¸ªè¾“å…¥ï¼Œä»¥ä¾¿å¯ä»¥æœç´¢ä»»æ„ `query` ã€‚å› æ­¤ï¼ŒgetFetchUrlç°åœ¨ä¸ä¼šå°† `query` ä½œä¸ºå‚æ•°ï¼Œè€Œæ˜¯ä»æœ¬åœ°çŠ¶æ€è¯»å–å®ƒã€‚
æˆ‘ä»¬ä¼šç«‹å³çœ‹åˆ°å®ƒç¼ºå°‘ `query` ä¾èµ–é¡¹ï¼š

``` js
function SearchResults() {
    const [query, setQuery] = useState('react');
    const getFetchUrl = useCallback(() => { // No query argument
        return 'https://hn.algolia.com/api/v1/search?query=' + query;
    }, []); // ğŸ”´ Missing dep: query
    // ...
}
```

å¦‚æœæˆ‘ä¿®å¤äº† `useCallback deps` ä»¥åŒ…å« `query` ï¼Œé‚£ä¹ˆæ¯å½“ `query` æ›´æ”¹æ—¶ï¼Œ `deps` ä¸­çš„ `getFetchUrl` çš„ä»»ä½•æ•ˆæœéƒ½ä¼šé‡æ–°è¿è¡Œï¼š

``` js
function SearchResults() {
    const [query, setQuery] = useState('react');

    // âœ… Preserves identity until query changes
    const getFetchUrl = useCallback(() => {
        return 'https://hn.algolia.com/api/v1/search?query=' + query;
    }, [query]); // âœ… Callback deps are OK

    useEffect(() => {
        const url = getFetchUrl();
        // ... Fetch data and do something ...
    }, [getFetchUrl]); // âœ… Effect deps are OK

    // ...
}
```

æ„Ÿè°¢ `useCallback` ï¼Œå¦‚æœ `query` ç›¸åŒï¼Œåˆ™ `getFetchUrl` ä¹Ÿä¿æŒä¸å˜ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„æ•ˆæœä¸ä¼šé‡æ–°è¿è¡Œã€‚ä½†æ˜¯å¦‚æœ `query` æ›´æ”¹ï¼Œ `getFetchUrl` ä¹Ÿä¼šæ›´æ”¹ï¼Œæˆ‘ä»¬å°†é‡æ–°è·å–æ•°æ®ã€‚è¿™å¾ˆåƒåœ¨ `Excel` ç”µå­è¡¨æ ¼ä¸­æ›´æ”¹æŸäº›å•å…ƒæ ¼æ—¶ï¼Œä½¿ç”¨å®ƒçš„å…¶ä»–å•å…ƒæ ¼ä¼šè‡ªåŠ¨é‡æ–°è®¡ç®—ã€‚
è¿™åªæ˜¯æ‹¥æŠ±æ•°æ®æµå’ŒåŒæ­¥æ€ç»´çš„ç»“æœã€‚**ç›¸åŒçš„è§£å†³æ–¹æ¡ˆé€‚ç”¨äºä»çˆ¶çº§ä¼ é€’çš„å‡½æ•°propsï¼š**

``` js
function Parent() {
    const [query, setQuery] = useState('react');

    // ä½ çš„å…³æ³¨ç‚¹åœ¨è¿™é‡Œ
    // âœ… Preserves identity until query changes
    const fetchData = useCallback(() => {
        const url = 'https://hn.algolia.com/api/v1/search?query=' + query;
        // ... Fetch data and return it ...
    }, [query]); // âœ… Callback deps are OK

    return <Child fetchData = {
        fetchData
    }
    />
}

function Child({
    fetchData
}) {
    let [data, setData] = useState(null);

    useEffect(() => {
        fetchData().then(setData);
    }, [fetchData]); // âœ… Effect deps are OK

    // ...
}
```

ç”±äº `fetchData` åªåœ¨ `query` çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šåœ¨ `Parent` å†…éƒ¨å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„ `Child` åœ¨åº”ç”¨ç¨‹åºçœŸæ­£éœ€è¦æ—¶æ‰ä¼šé‡æ–°è·å–æ•°æ®ã€‚

### å‡½æ•°æ˜¯æ•°æ®æµçš„ä¸€éƒ¨åˆ†å—ï¼Ÿ

æœ‰è¶£çš„æ˜¯ï¼Œç”¨ç±»æ‰“ç ´äº†è¿™ç§æ¨¡å¼ï¼ŒçœŸæ­£æ˜¾ç¤ºäº†æ•ˆæœå’Œç”Ÿå‘½å‘¨æœŸèŒƒä¾‹ä¹‹é—´çš„å·®å¼‚ã€‚è€ƒè™‘ä¸€ä¸‹è¿™ä¸ªè½¬æ¢:

``` js
class Parent extends Component {
    state = {
        query: 'react'
    };
    // ä½ çš„å…³æ³¨ç‚¹åœ¨è¿™é‡Œ(æ‰‹åŠ¨é«˜äº®)
    fetchData = () => {
        const url = 'https://hn.algolia.com/api/v1/search?query=' + this.state.query;
        // ... Fetch data and do something ...
    };
    render() {
        return <Child fetchData = {
            this.fetchData
        }
        />;
    }
}

class Child extends Component {
    state = {
        data: null
    };
    componentDidMount() {
        this.props.fetchData();
    }
    render() {
        // ...
    }
}
```

ä½ å¯èƒ½ä¼šæƒ³ï¼šâ€œå¾—äº†å§, æˆ‘ä»¬éƒ½çŸ¥é“ `useEffect` å°±åƒ `componentDidMount` å’Œ `componentDidUpdate` ç»“åˆåœ¨ä¸€èµ·ï¼Œä½ æ— æ³•ç»§ç»­å†æ‘‡æ——å‘å–Šäº†ï¼â€ **ç„¶è€Œï¼Œå³ä½¿ä½¿ç”¨componentDidUpdateï¼Œè¿™ä¹Ÿä¸èµ·ä½œç”¨ï¼š**

``` js
class Child extends Component {
    state = {
        data: null
    };
    componentDidMount() {
        this.props.fetchData();
    }
    componentDidUpdate(prevProps) {
        // ğŸ”´ This condition will never be true
        if (this.props.fetchData !== prevProps.fetchData) {
            this.props.fetchData();
        }
    }
    render() {
        // ...
    }
}
```

å½“ç„¶ï¼Œ `fetchData` æ˜¯ä¸€ä¸ªç±»çš„æ–¹æ³•ï¼(æˆ–è€…ï¼Œæ›´ç¡®åˆ‡åœ°è¯´ï¼Œä¸€ä¸ªç±»å±æ€§â€”â€”ä½†è¿™ä¸ä¼šæ”¹å˜ä»»ä½•ä¸œè¥¿ã€‚)ç”±äºçŠ¶æ€çš„å˜åŒ–ï¼Œå®ƒä¸ä¼šæœ‰æ‰€ä¸åŒã€‚æ‰€ä»¥ `this.props.fetchData` å°†ä¿æŒç­‰äº `prevProps.fetchData` ï¼Œæˆ‘ä»¬å°†æ°¸è¿œä¸ä¼šé‡æ–°è·å–ã€‚è®©æˆ‘ä»¬åˆ é™¤è¿™ä¸ªæ¡ä»¶å‘¢ï¼Ÿ

``` js
componentDidUpdate(prevProps) {
    this.props.fetchData();
}
```

å“¦ç­‰ç­‰ï¼Œè¿™ä¼šåœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶è·å–ã€‚(åœ¨ä¸Šé¢çš„æ ‘ä¸­æ·»åŠ ä¸€ä¸ªåŠ¨ç”»æ˜¯å‘ç°å®ƒçš„ä¸€ç§æœ‰è¶£çš„æ–¹å¼ã€‚) ä¹Ÿè®¸è®©æˆ‘ä»¬å°†å®ƒç»‘å®šåˆ°ç‰¹å®šçš„æŸ¥è¯¢ï¼Ÿ

``` js
render() {
    return <Child fetchData = {
        this.fetchData.bind(this, this.state.query)
    }
    />;
}
```

ä½†æ˜¯ï¼Œå³ä½¿queryæ²¡æœ‰æ”¹å˜ï¼Œ `this.props.fetchDataï¼== prevProps.fetchData` ä¹Ÿå§‹ç»ˆ ä¸º `true` ï¼æ‰€ä»¥æˆ‘ä»¬æ€»æ˜¯ä¼šé‡æ–°è·å–ã€‚
å¯¹äºç±»çš„è¿™ä¸ªéš¾é¢˜ï¼ŒæƒŸä¸€çœŸæ­£çš„è§£å†³æ–¹æ¡ˆæ˜¯å’¬ç´§ç‰™å…³ï¼Œå°† `query` æœ¬èº«ä¼ é€’ç»™ `Child` ç»„ä»¶ã€‚ `Child` å®é™…ä¸Šå¹¶æ²¡æœ‰æœ€ç»ˆä½¿ç”¨ `query` ï¼Œä½†å®ƒå¯ä»¥åœ¨æ›´æ”¹æ—¶è§¦å‘é‡æ–°è·å–ï¼š

``` js
class Parent extends Component {
    state = {
        query: 'react'
    };
    fetchData = () => {
        const url = 'https://hn.algolia.com/api/v1/search?query=' + this.state.query;
        // ... Fetch data and do something ...
    };
    render() {
        return <Child fetchData = {
            this.fetchData
        }
        query = {
            this.state.query
        }
        />;
    }
}

class Child extends Component {
    state = {
        data: null
    };
    componentDidMount() {
        this.props.fetchData();
    }
    componentDidUpdate(prevProps) {
        if (this.props.query !== prevProps.query) {
            this.props.fetchData();
        }
    }
    render() {
        // ...
    }
}
```

åœ¨å¤šå¹´ä½¿ç”¨Reactç±»çš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘å·²ç»ä¹ æƒ¯äº†ä¼ é€’ä¸å¿…è¦çš„propså¹¶ç ´åçˆ¶ç»„ä»¶çš„å°è£…ï¼Œç›´åˆ°ä¸€å‘¨å‰æˆ‘æ‰æ„è¯†åˆ°ä¸ºä»€ä¹ˆå¿…é¡»è¿™æ ·åšã€‚
**å¯¹äºç±»ï¼Œå‡½æ•°propsæœ¬èº«å¹¶ä¸æ˜¯æ•°æ®æµçš„çœŸæ­£ç»„æˆéƒ¨åˆ†ã€‚** æ–¹æ³•è¿‡äºç´§å¯†äºå¯å˜çš„ `this` å˜é‡ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸èƒ½ä¾èµ–å®ƒä»¬çš„æ ‡è¯†æ¥è¡¨ç¤ºä»»ä½•å†…å®¹ã€‚ å› æ­¤ï¼Œå³ä½¿æˆ‘ä»¬åªæƒ³è¦ä¸€ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»ä¼ é€’ä¸€å †å…¶ä»–æ•°æ®ï¼Œä»¥ä¾¿èƒ½å¤Ÿâ€œåŒºåˆ†â€å®ƒã€‚æˆ‘ä»¬æ— æ³•çŸ¥é“ä»çˆ¶çº§ä¼ é€’çš„ `this.props.fetchData` æ˜¯å¦ä¾èµ–äºæŸç§çŠ¶æ€ï¼Œä»¥åŠè¯¥çŠ¶æ€æ˜¯å¦åˆšåˆšæ›´æ”¹ã€‚

ä½¿ç”¨ `useCallback` ï¼Œå‡½æ•°å¯ä»¥å®Œå…¨å‚ä¸æ•°æ®æµã€‚ æˆ‘ä»¬å¯ä»¥è¯´ï¼Œå¦‚æœå‡½æ•°è¾“å…¥å‘ç”Ÿäº†å˜åŒ–ï¼Œå‡½æ•°æœ¬èº«å°±ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä½†å¦‚æœæ²¡æœ‰å˜åŒ–ï¼Œå®ƒå°±ä¼šä¿æŒä¸å˜ã€‚ç”±äº `useCallback` æä¾›çš„ç²’åº¦ï¼Œå¯¹ `props.fetchData` ç­‰ `props` çš„æ›´æ”¹å¯ä»¥è‡ªåŠ¨å‘ä¸‹ä¼ æ’­ã€‚
åŒæ ·ï¼Œ `useMemo` è®©æˆ‘ä»¬å¯¹å¤æ‚å¯¹è±¡ä¹Ÿè¿™æ ·åšï¼š

``` js
function ColorPicker() {
    // Doesn't break Child's shallow equality prop check
    // unless the color actually changes.
    const [color, setColor] = useState('pink');
    const style = useMemo(() => ({
        color
    }), [color]);
    return <Child style = {
        style
    }
    />;
}
```

**æˆ‘æƒ³å¼ºè°ƒçš„æ˜¯ï¼Œåœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨useCallbackéƒ½éå¸¸ç¬¨é‡ã€‚** å½“ä¸€ä¸ªå‡½æ•°ä¼ é€’ä¸‹å»å¹¶ä»ä¸€äº›å­ç»„ä»¶çš„æ•ˆæœå†…éƒ¨è°ƒç”¨æ—¶å®ƒå¾ˆæœ‰ç”¨ã€‚æˆ–è€…ï¼Œå¦‚æœä½ è¯•å›¾é˜»æ­¢ç ´åå­ç»„ä»¶çš„è®°å¿†ã€‚ä½†Hooksæ›´é€‚åˆäºé¿å…å›è°ƒå®Œå…¨ä¼ é€’ä¸‹æ¥ã€‚

åœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘æ›´å¸Œæœ› `fetchData` ä½äºæˆ‘çš„ `effect` (å®ƒæœ¬èº«å¯ä»¥è¢«æå–åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„é’©å­ä¸­)æˆ–é¡¶å±‚å¯¼å…¥ä¸­ã€‚æˆ‘å¸Œæœ›ä¿æŒ `effect` ç®€å•ï¼Œå¹¶ä¸”å…¶ä¸­çš„å›è°ƒå¯¹æ­¤æ²¡æœ‰å¸®åŠ©ã€‚(â€œå¦‚æœåœ¨è¯·æ±‚è¿è¡ŒæœŸé—´æŸäº› `props.onComplete` å›è°ƒå‘ç”Ÿäº†æ›´æ”¹ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿâ€) ä½ å¯ä»¥æ¨¡æ‹Ÿç±»è¡Œä¸ºï¼Œä½†è¿™å¹¶ä¸èƒ½è§£å†³ç«äº‰æ¡ä»¶ã€‚

### è¯´è¯´ç«äº‰æ¡ä»¶

ä½¿ç”¨ç±»çš„ç»å…¸æ•°æ®è·å–ç¤ºä¾‹å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

``` js
class Article extends Component {
    state = {
        article: null
    };
    componentDidMount() {
        this.fetchData(this.props.id);
    }
    async fetchData(id) {
        const article = await API.fetchArticle(id);
        this.setState({
            article
        });
    }
    // ...
}
```

ä½ å¯èƒ½çŸ¥é“ï¼Œè¿™æ®µä»£ç æœ‰äº›é—®é¢˜ã€‚å®ƒä¸å¤„ç†æ›´æ–°ã€‚æ‰€ä»¥ä½ å¯ä»¥åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„ç¬¬äºŒä¸ªç»å…¸ä¾‹å­æ˜¯è¿™æ ·çš„ï¼š

``` js
class Article extends Component {
    state = {
        article: null
    };
    componentDidMount() {
        this.fetchData(this.props.id);
    }
    componentDidUpdate(prevProps) {
        if (prevProps.id !== this.props.id) {
            this.fetchData(this.props.id);
        }
    }
    async fetchData(id) {
        const article = await API.fetchArticle(id);
        this.setState({
            article
        });
    }
    // ...
}
```

è¿™è‚¯å®šæ›´å¥½ï¼ä½†ä»–ä»ç„¶æœ‰äº›é—®é¢˜ã€‚å®ƒæœ‰é—®é¢˜çš„åŸå› æ˜¯è¯·æ±‚é¡ºåºå¯èƒ½å‡ºç°é—®é¢˜ã€‚å› æ­¤ï¼Œå¦‚æœæˆ‘æ­£åœ¨è·å– `{idï¼š10}` çš„æ•°æ®ï¼Œåˆ‡æ¢åˆ° `{idï¼š20}` ï¼Œä½† `{idï¼š20}` è¯·æ±‚é¦–å…ˆå‡ºç°ï¼Œå…ˆå‰å¼€å§‹ä½†ç¨åå®Œæˆçš„è¯·æ±‚å°†é”™è¯¯åœ°è¦†ç›–æˆ‘çš„çŠ¶æ€ã€‚

è¿™è¢«ç§°ä¸ºç«äº‰æ¡ä»¶ï¼Œå®ƒåœ¨ä»£ç ä¸­æ˜¯å…¸å‹çš„ï¼Œå°† `async/await` ï¼ˆå‡å®šæœ‰ä¸œè¥¿åœ¨ç­‰å¾…ç»“æœï¼‰ä¸è‡ªé¡¶å‘ä¸‹çš„æ•°æ®æµï¼ˆå½“æˆ‘ä»¬å¤„äºå¼‚æ­¥å‡½æ•°çš„ä¸­é—´æ—¶ï¼Œå±æ€§æˆ–çŠ¶æ€å¯èƒ½ä¼šæ”¹å˜ï¼‰æ··åˆåœ¨ä¸€èµ·ã€‚

æ•ˆæœå¹¶ä¸èƒ½ç¥å¥‡åœ°è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¦‚æœä½ è¯•å›¾å°† `async` å‡½æ•°ç›´æ¥ä¼ é€’ç»™æ•ˆæœï¼Œå®ƒä»¬ä¼šè­¦å‘Šä½ ã€‚(æˆ‘ä»¬éœ€è¦æ”¹è¿›è¿™ä¸ªè­¦å‘Šï¼Œä»¥ä¾¿æ›´å¥½åœ°è§£é‡Šä½ å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚)

å¦‚æœä½ ä½¿ç”¨çš„å¼‚æ­¥æ–¹æ³•æ”¯æŒå–æ¶ˆï¼Œé‚£å°±å¤ªæ£’äº†! ä½ å¯ä»¥åœ¨æ¸…ç†å‡½æ•°ä¸­å–æ¶ˆå¼‚æ­¥è¯·æ±‚ã€‚
**æˆ–è€…ï¼Œæœ€ç®€å•çš„æƒå®œä¹‹è®¡æ–¹æ³•æ˜¯ä½¿ç”¨å¸ƒå°”å€¼è·Ÿè¸ªå®ƒï¼š**

``` js
function Article({
    id
}) {
    const [article, setArticle] = useState(null);

    useEffect(() => {
        +
        let didCancel = false;
        async function fetchData() {
            const article = await API.fetchArticle(id); +
            if (!didCancel) {
                setArticle(article);
            }
        }

        fetchData();

        // è¿™é‡Œä¹Ÿæ˜¯ä½ çš„å…³æ³¨ç‚¹
        return () => {
            didCancel = true;
        };
    }, [id]);

    // ...
}
```

## æé«˜æ ‡å‡†

* ä½¿ç”¨ç±»ç”Ÿå‘½å‘¨æœŸæ€ç»´æ¨¡å¼ï¼Œå‰¯ä½œç”¨ä¸æ¸²æŸ“è¾“å‡ºçš„è¡Œä¸ºä¸åŒã€‚æ¸²æŸ“UIç”±propså’Œstateé©±åŠ¨ï¼Œå¹¶ä¿è¯ä¸å®ƒä»¬ä¸€è‡´ï¼Œä½†å‰¯ä½œç”¨ä¸æ˜¯ã€‚è¿™æ˜¯bugçš„å¸¸è§æ¥æºã€‚

* ä½¿ç”¨useEffectçš„æ€ç»´æ¨¡å¼ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼šåŒæ­¥äº‹ç‰©ã€‚å‰¯ä½œç”¨æˆä¸ºReactæ•°æ®æµçš„ä¸€éƒ¨åˆ†ã€‚å¯¹äºæ¯ä¸ªuseEffectè°ƒç”¨ï¼Œä¸€æ—¦ä½ åšå¯¹äº†ï¼Œä½ çš„ç»„ä»¶å°±ä¼šæ›´å¥½åœ°å¤„ç†è¾¹ç¼˜æƒ…å†µã€‚

* ç„¶è€Œï¼Œåšå¥½è¿™ä»¶äº‹çš„å‰æœŸæˆæœ¬æ›´é«˜ã€‚è¿™å¯èƒ½å¾ˆçƒ¦äººã€‚ç¼–å†™èƒ½å¤Ÿå¾ˆå¥½åœ°å¤„ç†è¾¹ç¼˜æƒ…å†µçš„åŒæ­¥ä»£ç ï¼Œæœ¬è´¨ä¸Šæ¯”å¼•å‘ä¸æ¸²æŸ“ä¸ä¸€è‡´çš„ä¸€æ¬¡æ€§å‰¯ä½œç”¨æ›´å›°éš¾ã€‚

* å¦‚æœuseEffectæ˜¯ä½ å¤§å¤šæ•°æ—¶é—´ä½¿ç”¨çš„å·¥å…·ï¼Œè¿™å¯èƒ½ä¼šä»¤äººæ‹…å¿§ã€‚ç„¶è€Œï¼Œå®ƒæ˜¯ä¸€ä¸ªä½å±‚çš„æ„å»ºå—ã€‚ç°åœ¨æ˜¯ä½¿ç”¨é’©å­çš„æ—©æœŸé˜¶æ®µï¼Œæ‰€ä»¥æ¯ä¸ªäººéƒ½ä¸€ç›´åœ¨ä½¿ç”¨ä½çº§åˆ«çš„é’©å­ï¼Œå°¤å…¶æ˜¯åœ¨æ•™ç¨‹ä¸­ã€‚ä½†æ˜¯åœ¨å®è·µä¸­ï¼Œéšç€å¥½çš„APIè·å¾—å‘å±•åŠ¿å¤´ï¼Œç¤¾åŒºå¾ˆå¯èƒ½ä¼šå¼€å§‹è½¬å‘æ›´é«˜çº§åˆ«çš„é’©å­ã€‚

* æˆ‘çœ‹åˆ°ä¸åŒçš„åº”ç”¨ç¨‹åºåˆ›å»ºäº†å®ƒä»¬è‡ªå·±çš„é’©å­ï¼Œæ¯”å¦‚å°è£…äº†å®ƒä»¬çš„ä¸€äº›åº”ç”¨ç¨‹åºçš„authé€»è¾‘çš„useFetchæˆ–ä½¿ç”¨ä¸»é¢˜ä¸Šä¸‹æ–‡çš„useThemeã€‚ä¸€æ—¦ä½ æœ‰äº†è¿™äº›å·¥å…·ç®±ï¼Œä½ å°±ä¸ä¼šç»å¸¸ä½¿ç”¨useEffectã€‚ä½†å®ƒå¸¦æ¥çš„å¼¹æ€§ä½¿æ¯ä¸ªHookéƒ½èƒ½åœ¨å…¶ä¸Šæ„å»ºã€‚

* åˆ°ç›®å‰ä¸ºæ­¢ï¼ŒuseEffectæœ€å¸¸ç”¨äºæ•°æ®è·å–ã€‚ä½†æ˜¯æ•°æ®æå–å¹¶ä¸æ˜¯ä¸€ä¸ªåŒæ­¥é—®é¢˜ã€‚è¿™ä¸€ç‚¹å°¤å…¶æ˜æ˜¾ï¼Œå› ä¸ºæˆ‘ä»¬çš„depsç»å¸¸æ˜¯[]ã€‚æˆ‘ä»¬åœ¨åŒæ­¥ä»€ä¹ˆ?

* ä»é•¿è¿œæ¥çœ‹ï¼Œæ•°æ®è·å–çš„suspenseå°†å…è®¸ç¬¬ä¸‰æ–¹åº“ä»¥ä¸€ç§ä¸€æµçš„æ–¹å¼å‘Šè¯‰Reactæš‚åœæ¸²æŸ“ï¼Œç›´åˆ°å¼‚æ­¥(ä»»ä½•ä¸œè¥¿: ä»£ç ã€æ•°æ®ã€å›¾åƒ)å°±ç»ªã€‚

* éšç€suspenseé€æ¸è¦†ç›–æ›´å¤šçš„æ•°æ®è·å–ç”¨ä¾‹ï¼Œæˆ‘é¢„è®¡å½“ä½ çœŸæ­£æƒ³è¦åŒæ­¥propså’ŒçŠ¶æ€åˆ°æŸä¸ªå‰¯ä½œç”¨æ—¶ï¼ŒuseEffectå°†ä½œä¸ºä¸€ä¸ªé«˜çº§ç”¨æˆ·å·¥å…·æ·¡å‡ºèƒŒæ™¯ã€‚ä¸æ•°æ®è·å–ä¸åŒï¼Œå®ƒå¯ä»¥å¾ˆè‡ªç„¶åœ°å¤„ç†è¿™ç§æƒ…å†µï¼Œå› ä¸ºå®ƒæ˜¯ä¸ºè¿™ç§æƒ…å†µè€Œè®¾è®¡çš„ã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œè¿™é‡Œæ‰€ç¤ºçš„è‡ªå®šä¹‰é’©å­æ˜¯é‡ç”¨æ•°æ®è·å–é€»è¾‘çš„å¥½æ–¹æ³•ã€‚

## ç¬”è€…ä¸ªäººæ€»ç»“

> å…¶å®è¿™ä¸ªå°±åƒå‰é¢æ‰€è¯´çš„ç±»å’Œå‡½æ•°çš„åŒºåˆ«äº†ã€‚å› ä¸ºåœ¨Reactä¸­ï¼Œpropsæ˜¯ä¸ä¼šæ”¹å˜çš„ï¼Œè€Œthis(state)æ˜¯å¯å˜çš„ã€‚æ‰€ä»¥é€ æˆäº†æ”¹å˜ã€‚ç”±äºpropsæ˜¯ä¸å¯å˜çš„ï¼Œè¿™æ ·é’ˆå¯¹æ¯æ¬¡çš„æ¸²æŸ“ï¼Œéƒ½ä¼šæœ‰ä¸€ä¸ªç‰¹å®šçš„æ¸²æŸ“(æ¯æ¬¡çš„æ¸²æŸ“)ã€‚

> å¯¹äºeffectå†…ä½¿ç”¨çš„å‡½æ•°ï¼Œæœ€å¥½æ˜¯æ”¾åœ¨effectä¸­ï¼Œè¿™æ ·å¯ä»¥é¿å…ä»¥åç»„ä»¶å¢åŠ è€Œæœªå¤„ç†æ‰€æœ‰çš„æƒ…å†µã€‚å¦‚æœæœ‰å¤ç”¨ï¼Œå¯ä»¥æŠŠè¿™äº›å‡½æ•°æåˆ°effectå¤–é¢ï¼Œä½¿ç”¨useCallbackåŒ…è£¹èµ·æ¥ã€‚

ä½œè€…ï¼šxiaohesong
é“¾æ¥ï¼šhttps://www.jianshu.com/p/ab432b6344f6
æ¥æºï¼šç®€ä¹¦
